<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐流派随时间变化热力图 | RYM Top 5000</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 40px;
            background: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .chart-container {
            margin-top: 30px;
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            pointer-events: none;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            max-width: 280px;
        }
        
        .tooltip h3 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .tooltip p {
            margin: 3px 0;
            color: #555;
        }
        
        .legend-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        
        .legend-label {
            font-size: 13px;
            color: #666;
            margin: 0 10px;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .axis-label {
            font-size: 14px;
            fill: #666;
            font-weight: 500;
        }
        
        .year-label {
            font-size: 12px;
            fill: #666;
        }
        
        .genre-label {
            font-size: 12px;
            fill: #444;
            font-weight: 500;
        }
        
        .chart-title {
            font-size: 18px;
            fill: #2c3e50;
            font-weight: 600;
        }
        
        .footer {
            margin-top: 25px;
            text-align: center;
            color: #95a5a6;
            font-size: 13px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>音乐流派流行度随时间变化热力图</h1>
        <div class="subtitle">展示RYM Top 5000专辑中不同音乐流派在各年代的分布情况</div>
        
        <div class="controls">
            <span>选择时间范围：</span>
            <select id="yearRange">
                <option value="all">全部年份 (1950-2023)</option>
                <option value="1960-1990">1960-1990</option>
                <option value="1990-2023">1990-2023</option>
            </select>
            
            <span>最小流派出现次数：</span>
            <select id="minCount">
                <option value="10">10+ 专辑</option>
                <option value="20">20+ 专辑</option>
                <option value="30">30+ 专辑</option>
                <option value="50">50+ 专辑</option>
            </select>
        </div>
        
        <div class="chart-container">
            <div id="heatmap-chart"></div>
            <div class="legend-container">
                <span class="legend-label">较少</span>
                <div id="color-legend"></div>
                <span class="legend-label">较多</span>
            </div>
        </div>
        
        <div class="footer">
            数据来源: RateYourMusic.com 社区评选的史上Top 5000专辑 | 可视化: D3.js
        </div>
    </div>

    <script>
        // 配置参数
        const config = {
            width: 1000,
            height: 700,
            margin: { top: 80, right: 150, bottom: 100, left: 180 },
            cellPadding: 2,
            yearBinSize: 5  // 按5年分组
        };
        
        // 创建SVG容器
        const svg = d3.select("#heatmap-chart")
            .append("svg")
            .attr("width", config.width)
            .attr("height", config.height)
            .append("g")
            .attr("transform", `translate(${config.margin.left}, ${config.margin.top})`);
        
        // 创建工具提示
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip");
        
        // 加载和处理数据
        d3.csv("rym_top_5000_all_time.csv").then(function(data) {
            // 数据预处理
            data.forEach(d => {
                d.Ranking = +d.Ranking;
                d["Average Rating"] = +d["Average Rating"];
                d["Number of Ratings"] = +d["Number of Ratings"].replace(/,/g, '');
                
                // 解析年份
                const dateStr = d["Release Date"];
                if (dateStr) {
                    const yearMatch = dateStr.match(/\d{4}/);
                    d.Year = yearMatch ? +yearMatch[0] : null;
                }
                
                // 解析流派（可能有多个，用逗号分隔）
                if (d.Genres) {
                    d.GenreList = d.Genres.split(',').map(g => g.trim());
                } else {
                    d.GenreList = [];
                }
            });
            
            // 过滤有效数据
            const validData = data.filter(d => d.Year && d.Year >= 1950 && d.Year <= 2023);
            
            // 初始化图表
            updateChart(validData, "all", 10);
            
            // 添加交互控制
            d3.select("#yearRange").on("change", function() {
                updateChart(validData, this.value, d3.select("#minCount").property("value"));
            });
            
            d3.select("#minCount").on("change", function() {
                updateChart(validData, d3.select("#yearRange").property("value"), this.value);
            });
            
            // 更新图表函数
            function updateChart(data, yearRange, minCount) {
                // 清空SVG
                svg.selectAll("*").remove();
                
                // 过滤年份范围
                let filteredData = data;
                if (yearRange !== "all") {
                    const [start, end] = yearRange.split("-").map(Number);
                    filteredData = data.filter(d => d.Year >= start && d.Year <= end);
                }
                
                // 按5年分组
                filteredData.forEach(d => {
                    d.YearBin = Math.floor(d.Year / config.yearBinSize) * config.yearBinSize;
                });
                
                // 提取所有流派并统计出现次数
                const genreCounts = {};
                filteredData.forEach(d => {
                    d.GenreList.forEach(genre => {
                        genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                    });
                });
                
                // 过滤出现次数较少的流派
                const minCountNum = +minCount;
                const topGenres = Object.entries(genreCounts)
                    .filter(([_, count]) => count >= minCountNum)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 25) // 取前25个流派
                    .map(([genre, _]) => genre);
                
                // 创建流派到年份的计数映射
                const genreYearCounts = {};
                topGenres.forEach(genre => {
                    genreYearCounts[genre] = {};
                });
                
                // 统计每个流派在每个年份分组中的出现次数
                filteredData.forEach(d => {
                    const yearBin = d.YearBin;
                    d.GenreList.forEach(genre => {
                        if (topGenres.includes(genre)) {
                            if (!genreYearCounts[genre][yearBin]) {
                                genreYearCounts[genre][yearBin] = 0;
                            }
                            genreYearCounts[genre][yearBin]++;
                        }
                    });
                });
                
                // 准备热力图数据
                const heatmapData = [];
                topGenres.forEach(genre => {
                    Object.keys(genreYearCounts[genre]).forEach(yearBin => {
                        heatmapData.push({
                            genre: genre,
                            yearBin: +yearBin,
                            count: genreYearCounts[genre][yearBin]
                        });
                    });
                });
                
                // 计算最大计数用于颜色比例尺
                const maxCount = d3.max(heatmapData, d => d.count);
                
                // 创建比例尺
                const xScale = d3.scaleBand()
                    .domain([...new Set(heatmapData.map(d => d.yearBin))].sort((a, b) => a - b))
                    .range([0, config.width - config.margin.left - config.margin.right])
                    .padding(0.05);
                
                const yScale = d3.scaleBand()
                    .domain(topGenres.reverse()) // 反转使最流行的在顶部
                    .range([0, config.height - config.margin.top - config.margin.bottom])
                    .padding(0.05);
                
                const colorScale = d3.scaleSequential()
                    .domain([0, maxCount])
                    .interpolator(d3.interpolateYlOrRd);
                
                // 绘制热力单元格
                svg.selectAll(".heat-cell")
                    .data(heatmapData)
                    .enter()
                    .append("rect")
                    .attr("class", "heat-cell")
                    .attr("x", d => xScale(d.yearBin))
                    .attr("y", d => yScale(d.genre))
                    .attr("width", xScale.bandwidth())
                    .attr("height", yScale.bandwidth())
                    .attr("fill", d => colorScale(d.count))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1)
                    .attr("rx", 3) // 圆角
                    .attr("ry", 3)
                    .on("mouseover", function(event, d) {
                        // 高亮当前单元格
                        d3.select(this)
                            .attr("stroke", "#2c3e50")
                            .attr("stroke-width", 2);
                        
                        // 显示工具提示
                        tooltip
                            .style("opacity", 1)
                            .html(`
                                <h3>${d.genre}</h3>
                                <p><strong>年代:</strong> ${d.yearBin}s</p>
                                <p><strong>专辑数量:</strong> ${d.count}</p>
                                <p><strong>占比:</strong> ${((d.count / filteredData.filter(item => 
                                    item.YearBin === d.yearBin).length) * 100).toFixed(1)}%</p>
                            `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 15) + "px");
                    })
                    .on("mouseout", function() {
                        // 恢复样式
                        d3.select(this)
                            .attr("stroke", "#fff")
                            .attr("stroke-width", 1);
                        
                        // 隐藏工具提示
                        tooltip.style("opacity", 0);
                    });
                
                // 添加X轴（年份）
                svg.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", `translate(0, ${config.height - config.margin.top - config.margin.bottom})`)
                    .call(d3.axisBottom(xScale).tickFormat(d => `${d}s`))
                    .selectAll("text")
                    .attr("class", "year-label")
                    .attr("text-anchor", "middle");
                
                // 添加X轴标签
                svg.append("text")
                    .attr("class", "axis-label")
                    .attr("text-anchor", "middle")
                    .attr("x", (config.width - config.margin.left - config.margin.right) / 2)
                    .attr("y", config.height - config.margin.top - config.margin.bottom + 40)
                    .text("年代 (按5年分组)");
                
                // 添加Y轴（流派）
                svg.append("g")
                    .attr("class", "y-axis")
                    .call(d3.axisLeft(yScale))
                    .selectAll("text")
                    .attr("class", "genre-label");
                
                // 添加Y轴标签
                svg.append("text")
                    .attr("class", "axis-label")
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)")
                    .attr("x", -(config.height - config.margin.top - config.margin.bottom) / 2)
                    .attr("y", -config.margin.left + 20)
                    .text("音乐流派");
                
                // 添加标题
                svg.append("text")
                    .attr("class", "chart-title")
                    .attr("text-anchor", "middle")
                    .attr("x", (config.width - config.margin.left - config.margin.right) / 2)
                    .attr("y", -30)
                    .text("RYM Top 5000专辑：音乐流派流行度随时间变化");
                
                // 创建颜色图例
                createColorLegend(colorScale, maxCount);
            }
            
            // 创建颜色图例函数
            function createColorLegend(colorScale, maxCount) {
                const legendWidth = 300;
                const legendHeight = 20;
                const legendContainer = d3.select("#color-legend").html("");
                
                const legendSvg = legendContainer.append("svg")
                    .attr("width", legendWidth)
                    .attr("height", legendHeight + 30);
                
                const defs = legendSvg.append("defs");
                const gradient = defs.append("linearGradient")
                    .attr("id", "legend-gradient")
                    .attr("x1", "0%")
                    .attr("x2", "100%")
                    .attr("y1", "0%")
                    .attr("y2", "0%");
                
                // 创建渐变
                const stops = [0, 0.25, 0.5, 0.75, 1];
                stops.forEach(stop => {
                    gradient.append("stop")
                        .attr("offset", `${stop * 100}%`)
                        .attr("stop-color", colorScale(stop * maxCount));
                });
                
                // 绘制渐变条
                legendSvg.append("rect")
                    .attr("x", 0)
                    .attr("y", 5)
                    .attr("width", legendWidth)
                    .attr("height", legendHeight)
                    .style("fill", "url(#legend-gradient)")
                    .attr("rx", 4)
                    .attr("ry", 4);
                
                // 添加图例刻度
                const legendScale = d3.scaleLinear()
                    .domain([0, maxCount])
                    .range([0, legendWidth]);
                
                const legendAxis = d3.axisBottom(legendScale)
                    .ticks(5)
                    .tickFormat(d3.format("d"));
                
                legendSvg.append("g")
                    .attr("transform", `translate(0, ${legendHeight + 5})`)
                    .call(legendAxis)
                    .selectAll("text")
                    .style("font-size", "11px")
                    .style("fill", "#666");
            }
        }).catch(function(error) {
            console.error("加载数据时出错:", error);
            d3.select("#heatmap-chart")
                .append("div")
                .style("color", "#e74c3c")
                .style("padding", "20px")
                .style("text-align", "center")
                .html("<h3>数据加载失败</h3><p>请确保CSV文件位于正确路径并刷新页面。</p>");
        });
    </script>
</body>
</html>